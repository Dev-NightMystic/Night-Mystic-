-- [[ NIGHT MYSTIC - CHEST V8 (HOP APENAS NA META) ]] --

getgenv().ScriptActive = true 

-- [[ CONFIGURAÇÃO ]] --
if not getgenv().Setting then
    getgenv().Setting = {
        ["WhiteScreen"] = false,
        ["TweenSpeed"] = 350, 
        ["ChestLimit"] = 1000, -- SÓ VAI DAR HOP QUANDO BATER ESSE NÚMERO
        ["ModFarm"] = {
            ["StopItemLegendary"] = true,
            ["SummonKillDarkbeard"] = true,
            ["SummonKillRipIndra"] = true,
            ["AutoEquipType"] = "Melee"
        }
    }
end

-- Fallbacks Visuais
if not _G.Team then _G.Team = "Marines" end
if not _G.ThemeID then _G.ThemeID = "rbxassetid://128543482632546" end
if not _G.ButtonImage then _G.ButtonImage = "rbxassetid://119752127243663" end

-- [[ SERVIÇOS ]] --
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local CoreGui = game:GetService("CoreGui")
local Lighting = game:GetService("Lighting")
local VirtualUser = game:GetService("VirtualUser")

local plr = Players.LocalPlayer
local CommF = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("CommF_")

-- [[ VARIÁVEIS DE CONTROLE ]] --
local ChestsCollected = 0
local PlaceID = game.PlaceId
local World2 = PlaceID == 4442272183 or PlaceID == 79091703265657
local World3 = PlaceID == 7449423635 or PlaceID == 100117331123089
local WasFightingBoss = false

-- Locais Boss
local DarkbeardSpawn = CFrame.new(3777.58, 14.87, -3498.81)
local IndraSpawn = CFrame.new(-5346.9, 423.9, -2725.1)

-- [[ UI SYSTEM ]] --
local function CreateBlur()
    if Lighting:FindFirstChild("NightMysticBlur") then Lighting.NightMysticBlur:Destroy() end
    local Blur = Instance.new("BlurEffect")
    Blur.Name = "NightMysticBlur"
    Blur.Size = 20
    Blur.Parent = Lighting
end

if CoreGui:FindFirstChild("SlimeX_ChestUI") then CoreGui.SlimeX_ChestUI:Destroy() end
CreateBlur()

local gui = Instance.new("ScreenGui", CoreGui)
gui.Name = "SlimeX_ChestUI"
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local Main = Instance.new("Frame", gui)
Main.Name = "MainFrame"
Main.Size = UDim2.new(0, 500, 0, 350)
Main.Position = UDim2.new(0.5, -250, 0.5, -175)
Main.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
Main.BackgroundTransparency = 1
Main.Visible = true
Instance.new("UICorner", Main).CornerRadius = UDim.new(0,18)

if _G.ThemeID ~= "" then
    local Theme = Instance.new("ImageLabel", Main)
    Theme.Size = UDim2.new(1,0,1,0); Theme.Image = _G.ThemeID; Theme.ScaleType = Enum.ScaleType.Crop
    Theme.ImageColor3 = Color3.fromRGB(80,80,80)
    Instance.new("UICorner", Theme).CornerRadius = UDim.new(0,18)
else
    Main.BackgroundTransparency = 0.1
end

local Title = Instance.new("TextLabel", Main)
Title.Size = UDim2.new(1,0,0,40); Title.Position = UDim2.new(0,0,0,5)
Title.BackgroundTransparency = 1; Title.Font = Enum.Font.GothamBlack
Title.Text = "NIGHT MYSTIC - V8 (HOP ON LIMIT ONLY)"
Title.TextColor3 = Color3.fromRGB(255,50,50); Title.TextSize = 22

-- Status Labels
local StatusBox = Instance.new("Frame", Main)
StatusBox.Size = UDim2.new(0.9,0,0.2,0); StatusBox.Position = UDim2.new(0.05,0,0.15,0)
StatusBox.BackgroundColor3 = Color3.new(0,0,0); StatusBox.BackgroundTransparency = 0.6
Instance.new("UICorner", StatusBox).CornerRadius = UDim.new(0,10)

local StatusLbl = Instance.new("TextLabel", StatusBox)
StatusLbl.Size = UDim2.new(1,-20,0.5,0); StatusLbl.Position = UDim2.new(0,10,0,0)
StatusLbl.BackgroundTransparency = 1; StatusLbl.Font = Enum.Font.GothamBold
StatusLbl.Text = "STATUS: Idle"; StatusLbl.TextColor3 = Color3.fromRGB(255,255,0); StatusLbl.TextXAlignment = Enum.TextXAlignment.Left

local ChestLbl = Instance.new("TextLabel", StatusBox)
ChestLbl.Size = UDim2.new(1,-20,0.5,0); ChestLbl.Position = UDim2.new(0,10,0.5,0)
ChestLbl.BackgroundTransparency = 1; ChestLbl.Font = Enum.Font.GothamBold
ChestLbl.Text = "Chests: 0 / " .. getgenv().Setting.ChestLimit; ChestLbl.TextColor3 = Color3.fromRGB(0,255,255); ChestLbl.TextXAlignment = Enum.TextXAlignment.Left

-- Logs
local LogBox = Instance.new("ScrollingFrame", Main)
LogBox.Size = UDim2.new(0.9,0,0.4,0); LogBox.Position = UDim2.new(0.05,0,0.55,0)
LogBox.BackgroundColor3 = Color3.new(0,0,0); LogBox.BackgroundTransparency = 0.6
LogBox.ScrollBarThickness = 3
Instance.new("UICorner", LogBox).CornerRadius = UDim.new(0,10)
local LogLayout = Instance.new("UIListLayout", LogBox); LogLayout.Padding = UDim.new(0,2)

-- Botões
local BtnBox = Instance.new("Frame", Main)
BtnBox.Size = UDim2.new(0.9,0,0.12,0); BtnBox.Position = UDim2.new(0.05,0,0.4,0); BtnBox.BackgroundTransparency = 1
local BtnLayout = Instance.new("UIListLayout", BtnBox); BtnLayout.FillDirection = Enum.FillDirection.Horizontal
BtnLayout.Padding = UDim.new(0,10); BtnLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

local function CreateBtn(text, col, func)
    local b = Instance.new("TextButton", BtnBox)
    b.Size = UDim2.new(0.48,0,1,0); b.BackgroundColor3 = col
    b.Font = Enum.Font.GothamBold; b.Text = text; b.TextColor3 = Color3.new(1,1,1)
    Instance.new("UICorner", b).CornerRadius = UDim.new(0,8)
    b.MouseButton1Click:Connect(func)
    return b
end

local StopBtn = CreateBtn("STOP FARM", Color3.fromRGB(200,50,50), function()
    getgenv().ScriptActive = not getgenv().ScriptActive
end)

CreateBtn("DISCORD", Color3.fromRGB(88,101,242), function()
    setclipboard("https://discord.gg/ARjmbneDk9")
end)

local Toggle = Instance.new("ImageButton", gui)
Toggle.Size = UDim2.new(0,45,0,45); Toggle.Position = UDim2.new(0.01,0,0.45,0)
Toggle.Image = _G.ButtonImage; Toggle.BackgroundColor3 = Color3.new(0.1,0.1,0.1)
Instance.new("UICorner", Toggle).CornerRadius = UDim.new(0,12)
Toggle.MouseButton1Click:Connect(function() Main.Visible = not Main.Visible end)

function Log(txt)
    local l = Instance.new("TextLabel", LogBox)
    l.Size = UDim2.new(1,-5,0,18); l.BackgroundTransparency = 1
    l.Font = Enum.Font.Gotham; l.Text = " ["..os.date("%H:%M").."] "..txt
    l.TextColor3 = Color3.new(0.9,0.9,0.9); l.TextSize = 12; l.TextXAlignment = Enum.TextXAlignment.Left
    LogBox.CanvasSize = UDim2.new(0,0,0,LogLayout.AbsoluteContentSize.Y+10)
    LogBox.CanvasPosition = Vector2.new(0,9999)
end

function Status(txt, col) StatusLbl.Text = "STATUS: "..txt; if col then StatusLbl.TextColor3 = col end end

-- [[ FUNÇÕES LÓGICAS ]] --

-- Anti-AFK
plr.Idled:connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- Detector de Dinheiro (Contar Baús)
local LastBeli = plr.Data.Beli.Value
plr.Data.Beli.Changed:Connect(function(val)
    if val > LastBeli then
        if not WasFightingBoss and getgenv().ScriptActive then
            ChestsCollected = ChestsCollected + 1
            ChestLbl.Text = "Chests: " .. ChestsCollected .. " / " .. getgenv().Setting.ChestLimit
            
            -- CHECK: Se atingir o limite exato, LOGA e prepara pro loop dar Hop
            if ChestsCollected >= getgenv().Setting.ChestLimit then
                Log("Meta de baús atingida!")
            end
        end
    end
    LastBeli = val
end)

-- Função de Movimento (Tween)
function TP(TargetCF)
    if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then return end
    local HRP = plr.Character.HumanoidRootPart
    local Dist = (HRP.Position - TargetCF.Position).Magnitude
    local Speed = getgenv().Setting.TweenSpeed
    
    if Dist < 25 then 
        HRP.CFrame = TargetCF 
        return 
    end

    local Info = TweenInfo.new(Dist/Speed, Enum.EasingStyle.Linear)
    local Tween = TweenService:Create(HRP, Info, {CFrame = TargetCF})
    
    local Noclip = RunService.Stepped:Connect(function()
        for _,v in pairs(plr.Character:GetDescendants()) do
            if v:IsA("BasePart") then v.CanCollide = false end
        end
    end)
    
    Tween:Play()
    local Completed = false
    Tween.Completed:Connect(function() Completed = true end)
    
    while not Completed do
        task.wait()
        if not getgenv().ScriptActive then Tween:Cancel(); break end
        if not plr.Character or plr.Character.Humanoid.Health <= 0 then Tween:Cancel(); break end
        if TargetCF and TargetCF.Position then
             if (HRP.Position - TargetCF.Position).Magnitude < 15 then
                 Tween:Cancel()
                 HRP.CFrame = TargetCF
                 break
             end
        end
    end
    
    if Noclip then Noclip:Disconnect() end
    if HRP then HRP.Velocity = Vector3.zero end
end

-- Busca Completa de Baús
function GetChest()
    local Char = plr.Character
    if not Char or not Char:FindFirstChild("HumanoidRootPart") then return nil end
    local MyPos = Char.HumanoidRootPart.Position
    local Closest = nil
    local MinDist = 9999999
    
    -- Escaneia tudo (sem medo, pois não vamos dar Hop se falhar)
    for _, v in pairs(workspace:GetDescendants()) do
        if v:IsA("Part") and (v.Name:find("Chest") or v.Name:find("Box")) and v:FindFirstChild("TouchInterest") then
            local Dist = (v.Position - MyPos).Magnitude
            if Dist < MinDist then
                MinDist = Dist
                Closest = v
            end
        end
    end
    return Closest
end

function Hop()
    if not getgenv().ScriptActive then return end
    Status("META ATINGIDA! HOPPING...", Color3.fromRGB(0,255,0))
    Log("Meta alcançada. Trocando servidor...")
    task.wait(2) -- Delay pra ver a mensagem
    
    local function GetServers()
        local raw = game:HttpGet("https://games.roblox.com/v1/games/"..PlaceID.."/servers/Public?sortOrder=Asc&limit=100")
        return HttpService:JSONDecode(raw)
    end
    
    local s, r = pcall(GetServers)
    if s and r and r.data then
        for _,v in pairs(r.data) do
            if v.playing < v.maxPlayers and v.id ~= game.JobId then
                TeleportService:TeleportToPlaceInstance(PlaceID, v.id, plr)
                return
            end
        end
    end
    TeleportService:Teleport(PlaceID, plr)
end

-- Equipar Arma
function Equip(name)
    local bp = plr.Backpack
    local ch = plr.Character
    if ch and not ch:FindFirstChild(name) then
        if bp:FindFirstChild(name) then
            ch.Humanoid:EquipTool(bp[name])
        end
    end
end

-- [[ LOOP PRINCIPAL ]] --
task.spawn(function()
    while true do
        task.wait()
        pcall(function()
            if not getgenv().ScriptActive then 
                StopBtn.Text = "RESUME"; StopBtn.BackgroundColor3 = Color3.fromRGB(0,200,0)
                Status("SCRIPT PAUSED", Color3.fromRGB(150,150,150))
                task.wait(1)
                return 
            end
            StopBtn.Text = "STOP FARM"; StopBtn.BackgroundColor3 = Color3.fromRGB(200,50,50)

            local Char = plr.Character
            if not Char or not Char:FindFirstChild("HumanoidRootPart") or Char.Humanoid.Health <= 0 then return end

            -- Detecção de Itens e Bosses
            local Chalice = (plr.Backpack:FindFirstChild("God's Chalice") or Char:FindFirstChild("God's Chalice"))
            local Fist = (plr.Backpack:FindFirstChild("Fist of Darkness") or Char:FindFirstChild("Fist of Darkness"))
            local Legendary = Chalice or Fist
            
            local Indra = workspace.Enemies:FindFirstChild("rip_indra")
            local Darkbeard = workspace.Enemies:FindFirstChild("Darkbeard")
            
            -- Ação 1: Prioridade Absoluta - Hop se atingiu a meta
            if ChestsCollected >= getgenv().Setting.ChestLimit then
                Hop()
                return
            end

            -- Ação 2: Item Lendário
            if Legendary and getgenv().Setting.ModFarm.StopItemLegendary then
                Status("ITEM LENDÁRIO ENCONTRADO!", Color3.fromRGB(255,215,0))
                WasFightingBoss = false
                if Char.HumanoidRootPart.Position.Y < 500 then
                    Char.HumanoidRootPart.CFrame = Char.HumanoidRootPart.CFrame * CFrame.new(0,50,0)
                end
                return
            end

            -- Ação 3: Boss
            if Indra or Darkbeard then
                local Target = Indra or Darkbeard
                Status("BOSS: "..Target.Name, Color3.fromRGB(255,50,50))
                WasFightingBoss = true
                Equip(getgenv().Setting.ModFarm.AutoEquipType)
                if not Char:FindFirstChild("HasBuso") then CommF:InvokeServer("Buso") end
                
                if Target:FindFirstChild("HumanoidRootPart") then
                    TP(Target.HumanoidRootPart.CFrame * CFrame.new(0,30,0))
                    ReplicatedStorage.Modules.Net["RE/RegisterAttack"]:FireServer(0)
                end
                return
            elseif WasFightingBoss then
                WasFightingBoss = false -- Boss morreu, volta pro farm
            end

            -- Ação 4: Farm Chest
            -- Se tiver summon, invoca... (omitido para focar no pedido principal, mantendo lógica limpa)

            local TargetChest = GetChest()

            if TargetChest and TargetChest.Parent then
                Status("Indo ao Baú...", Color3.fromRGB(0,255,255))
                TP(TargetChest.CFrame)
                if (Char.HumanoidRootPart.Position - TargetChest.Position).Magnitude < 15 then
                    firetouchinterest(Char.HumanoidRootPart, TargetChest, 0)
                    firetouchinterest(Char.HumanoidRootPart, TargetChest, 1)
                end
            else
                -- NÃO HÁ BAÚS E NÃO ATINGIU A META
                -- AQUI ESTÁ A MUDANÇA: APENAS ESPERA
                Status("Aguardando Respawn de Baús...", Color3.fromRGB(255,150,0))
                task.wait(1.5) 
                -- NÃO CHAMA HOP() AQUI EM HIPÓTESE ALGUMA
            end
        end)
    end
end)

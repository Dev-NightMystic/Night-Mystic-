-- [[ 2. PARTE INTERNA (LÓGICA PRINCIPAL) ]] --

if not getgenv().Setting then
    warn("Configurações não encontradas! Carregando padrão...")
    getgenv().Setting = {
        ["WhiteScreen"] = false, ["TweenSpeed"] = 300, ["MaxTimeServer"] = 900,
        ["ModFarm"] = {["StopItemLegendary"]=true, ["SummonKillDarkbeard"]=true, ["SummonKillRipIndra"]=true, ["AutoEquipType"]="Melee"}
    }
end

-- [[ SERVIÇOS ]] --
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")

local plr = Players.LocalPlayer
local Remotes = ReplicatedStorage:WaitForChild("Remotes")
local CommF = Remotes:WaitForChild("CommF_")

-- [[ VARIÁVEIS DE CONTROLE ]] --
local ProcessingBoss = false
local PlaceID = game.PlaceId
local World2 = PlaceID == 4442272183 or PlaceID == 79091703265657
local World3 = PlaceID == 7449423635 or PlaceID == 100117331123089

local ServerStartTime = tick() -- Marca o início
local WasFightingBoss = false  -- Memória de combate

-- [[ OTIMIZAÇÃO ]] --
if getgenv().Setting.WhiteScreen then
    RunService:Set3dRenderingEnabled(false)
end

-- [[ ANTI-AFK ]] --
plr.Idled:connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- [[ FUNÇÕES ÚTEIS ]] --

function EquipTool(toolNameOrType)
    local backpack = plr.Backpack
    local char = plr.Character
    local hum = char and char:FindFirstChild("Humanoid")
    if not hum then return end

    local targetTool = nil
    for _, tool in pairs(backpack:GetChildren()) do
        if tool:IsA("Tool") then
            if tool.Name == toolNameOrType or tool.ToolTip == toolNameOrType then
                targetTool = tool
                break
            end
        end
    end

    if not targetTool then
        for _, tool in pairs(char:GetChildren()) do
            if tool:IsA("Tool") and (tool.Name == toolNameOrType or tool.ToolTip == toolNameOrType) then
                return 
            end
        end
    end

    if targetTool then hum:EquipTool(targetTool) end
end

local function JoinTeam()
    local target = _G.Team or "Marines"
    if plr.Team == nil or (plr.Team.Name ~= "Marines" and plr.Team.Name ~= "Pirates") then
        pcall(function() CommF:InvokeServer("SetTeam", target) end)
        task.wait(1)
    end
end
JoinTeam()

-- [[ SISTEMA DE TWEEN ]] --
function MoveToPosition(TargetCF)
    -- Se o personagem não existir (morto), retorna para o loop esperar o respawn
    if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then return end
    
    local HRP = plr.Character.HumanoidRootPart
    local Speed = getgenv().Setting.TweenSpeed
    local Distance = (HRP.Position - TargetCF.Position).Magnitude
    
    if Distance < 15 then HRP.CFrame = TargetCF return end

    local Time = Distance / Speed
    local BV = Instance.new("BodyVelocity")
    BV.Name = "FlyVelocity"
    BV.Parent = HRP
    BV.Velocity = Vector3.new(0, 0, 0)
    BV.MaxForce = Vector3.new(1e9, 1e9, 1e9)
    
    local TI = TweenInfo.new(Time, Enum.EasingStyle.Linear)
    local Tween = TweenService:Create(HRP, TI, {CFrame = TargetCF})
    
    local NoclipLoop = RunService.Stepped:Connect(function()
        if plr.Character then
            for _, v in pairs(plr.Character:GetDescendants()) do
                if v:IsA("BasePart") then v.CanCollide = false end
            end
        end
    end)
    
    Tween:Play()
    local TweenCompleted = false
    Tween.Completed:Connect(function() TweenCompleted = true end)
    
    repeat 
        task.wait()
        if ProcessingBoss then BV.Velocity = Vector3.zero end
        -- Se o personagem morrer no meio do voo, cancela para reiniciar a lógica
        if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then
            Tween:Cancel()
            break
        end
    until TweenCompleted
    
    if NoclipLoop then NoclipLoop:Disconnect() end
    if BV then BV:Destroy() end
    if HRP then HRP.Velocity = Vector3.zero end
end

-- [[ FAST ATTACK ]] --
local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegisterHit = Net:WaitForChild("RE/RegisterHit")
local RegisterAttack = Net:WaitForChild("RE/RegisterAttack")

task.spawn(function()
    while task.wait(0.1) do
        pcall(function()
            local char = plr.Character
            if not char then return end
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if not hrp then return end
            
            local enemiesFolder = workspace:FindFirstChild("Enemies")
            if enemiesFolder then
                for _, enemy in ipairs(enemiesFolder:GetChildren()) do
                    if enemy:FindFirstChild("Humanoid") and enemy.Humanoid.Health > 0 and enemy:FindFirstChild("HumanoidRootPart") then
                        if (enemy.HumanoidRootPart.Position - hrp.Position).Magnitude < 60 then
                             RegisterAttack:FireServer(0)
                             RegisterHit:FireServer(enemy.HumanoidRootPart, {{enemy, enemy.HumanoidRootPart}})
                        end
                    end
                end
            end
        end)
    end
end)

-- [[ SISTEMA DE BAÚS E HOP ]] --
function GetClosestChest()
    local Character = plr.Character
    if not Character or not Character:FindFirstChild("HumanoidRootPart") then return nil end
    local RootPart = Character.HumanoidRootPart
    
    local Chests = {}
    for _, v in pairs(workspace:GetDescendants()) do
        if v:IsA("Part") and (string.find(v.Name, "Chest") or string.find(v.Name, "Box")) then
            if v:FindFirstChild("TouchInterest") then
                table.insert(Chests, v)
            end
        end
    end
    if #Chests == 0 then return nil end
    table.sort(Chests, function(a, b)
        return (a.Position - RootPart.Position).Magnitude < (b.Position - RootPart.Position).Magnitude
    end)
    return Chests[1]
end

function HopServer()
    print("Executando Hop Server...")
    local PlaceID = game.PlaceId
    local AllIDs = {}
    local function ListServers(cursor)
        local Raw = game:HttpGet("https://games.roblox.com/v1/games/" .. PlaceID .. "/servers/Public?sortOrder=Asc&limit=100" .. (cursor and "&cursor=" .. cursor or ""))
        return HttpService:JSONDecode(Raw)
    end
    
    local Success, ServerSource = pcall(ListServers)
    if not Success then 
        task.wait(2) HopServer() return 
    end

    for _, v in pairs(ServerSource.data) do
        if v.playing < v.maxPlayers and v.id ~= game.JobId then
            table.insert(AllIDs, v.id)
        end
    end
    
    if #AllIDs > 0 then
        TeleportService:TeleportToPlaceInstance(PlaceID, AllIDs[math.random(1, #AllIDs)], plr)
    else
        TeleportService:Teleport(PlaceID, plr)
    end
end

-- [[ LÓGICA DO BOSS (Darkbeard / Indra) ]] --
function EquipHakiColor(colorName)
    local args = { [1] = { StorageName = colorName, Type = "AuraSkin", Context = "Equip" } }
    ReplicatedStorage.Modules.Net["RF/FruitCustomizerRF"]:InvokeServer(unpack(args))
end

function ActivateIndraButtons()
    if not World3 then return true end
    local Summoner = workspace.Map:FindFirstChild("Boat Castle") and workspace.Map["Boat Castle"]:FindFirstChild("Summoner")
    if not Summoner then return false end
    
    local Circle = Summoner:FindFirstChild("Circle")
    if not Circle then return false end

    local allActive = true
    local HakiColors = {["Really red"] = "Pure Red", ["Oyster"] = "Snow White", ["Hot pink"] = "Winter Sky"}

    for _, pad in pairs(Circle:GetChildren()) do
        if pad.Name == "Part" and pad:FindFirstChild("Part") then
            local plate = pad.Part
            if tostring(plate.BrickColor) ~= "Lime green" then
                allActive = false
                local requiredColor = HakiColors[tostring(plate.BrickColor)]
                if requiredColor then
                    EquipHakiColor(requiredColor)
                    task.wait(0.2)
                    MoveToPosition(pad.CFrame + Vector3.new(0, 3, 0))
                    task.wait(1)
                end
            end
        end
    end
    return allActive
end

-- [[ LOOP PRINCIPAL DE DECISÃO ]] --
task.spawn(function()
    while task.wait() do
        pcall(function()
            -- Se estiver morto, espera renascer sem fazer nada
            if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then 
                return 
            end
            
            local Char = plr.Character
            
            -- 1. Verifica Itens Lendários
            local Chalice = plr.Backpack:FindFirstChild("God's Chalice") or Char:FindFirstChild("God's Chalice")
            local Fist = plr.Backpack:FindFirstChild("Fist of Darkness") or Char:FindFirstChild("Fist of Darkness")
            local HasLegendaryItem = (Chalice or Fist)

            -- 2. Detecta Boss
            local Indra = workspace.Enemies:FindFirstChild("rip_indra")
            local Darkbeard = workspace.Enemies:FindFirstChild("Darkbeard")
            local TargetBoss = Indra or Darkbeard

            -- >>> REGRA 1: HOP POR MORTE DO BOSS <<<
            -- Se estávamos lutando e o Boss sumiu (não é bug de respawn, pois o enemies folder é persistente)
            if not TargetBoss and WasFightingBoss then
                print("Boss morreu! Dando Hop Server agora!")
                WasFightingBoss = false
                HopServer()
                return
            end

            -- >>> REGRA 2: HOP POR TEMPO (SÓ SE NÃO TIVER ITEM E NÃO TIVER BOSS) <<<
            local TimeElapsed = tick() - ServerStartTime
            local TimeLimitReached = (TimeElapsed > getgenv().Setting.MaxTimeServer)
            
            -- Só pula por tempo se: Passou do tempo E NÃO tem item E NÃO tem boss vivo
            if TimeLimitReached and not HasLegendaryItem and not TargetBoss then
                print("Tempo esgotado e sem itens. Dando Hop Server...")
                HopServer()
                return
            end
            
            -- Se tem item ou boss, o script continua aqui (IGNORANDO O TEMPO)

            -- 3. Ações de Combate / Spawn
            if TargetBoss and TargetBoss:FindFirstChild("Humanoid") and TargetBoss.Humanoid.Health > 0 then
                -- ESTADO: LUTANDO CONTRA BOSS
                ProcessingBoss = true
                WasFightingBoss = true -- Marca que a luta começou/está rolando
                
                -- Se você morreu e voltou, ele vai entrar aqui direto e equipar
                EquipTool(getgenv().Setting.ModFarm.AutoEquipType)
                if not Char:FindFirstChild("HasBuso") then CommF:InvokeServer("Buso") end

                if TargetBoss:FindFirstChild("HumanoidRootPart") then
                    local BossPos = TargetBoss.HumanoidRootPart.CFrame * CFrame.new(0, 25, 0)
                    MoveToPosition(BossPos)
                end

            elseif World3 and Chalice and getgenv().Setting.ModFarm.SummonKillRipIndra then
                ProcessingBoss = true
                WasFightingBoss = false -- Ainda não é luta, é setup
                local buttonsReady = false
                repeat 
                    buttonsReady = ActivateIndraButtons()
                    task.wait(0.1)
                until buttonsReady
                
                EquipTool("God's Chalice")
                MoveToPosition(CFrame.new(-5346.9, 423.9, -2725.1))
                task.wait(2)

            elseif World2 and Fist and getgenv().Setting.ModFarm.SummonKillDarkbeard then
                ProcessingBoss = true
                WasFightingBoss = false
                EquipTool("Fist of Darkness")
                MoveToPosition(CFrame.new(3777.58, 14.87, -3498.81))
                task.wait(2)

            else
                -- ESTADO: FARM DE BAÚ
                -- Se tiver item lendário, mas não tem boss spawnado, fica PARADO (não farma baú pra não morrer de bobeira)
                if HasLegendaryItem and getgenv().Setting.ModFarm.StopItemLegendary then
                    ProcessingBoss = true
                    WasFightingBoss = false
                    -- Fica parado esperando o usuário invocar ou algo acontecer
                else
                    -- Vida normal: Farma baú até dar o tempo limite
                    ProcessingBoss = false
                    WasFightingBoss = false
                    
                    local TargetChest = GetClosestChest()
                    if TargetChest then
                        MoveToPosition(TargetChest.CFrame)
                        if Char:FindFirstChild("HumanoidRootPart") then
                            if (Char.HumanoidRootPart.Position - TargetChest.Position).Magnitude < 10 then
                                firetouchinterest(Char.HumanoidRootPart, TargetChest, 0)
                                firetouchinterest(Char.HumanoidRootPart, TargetChest, 1)
                            end
                        end
                    else
                        task.wait(1.5)
                        if not GetClosestChest() then
                            HopServer()
                        end
                    end
                end
            end
        end)
    end
end)

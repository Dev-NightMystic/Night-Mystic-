-- [[ 2. PARTE INTERNA: LÓGICA DO SCRIPT ]] --

-- Serviços
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("StarterGui")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")

local plr = Players.LocalPlayer
local Remotes = ReplicatedStorage:WaitForChild("Remotes")
local CommF = Remotes:WaitForChild("CommF_")

-- Detecção de Mundo
local PlaceID = game.PlaceId
local World2 = PlaceID == 4442272183 or PlaceID == 79091703265657
local World3 = PlaceID == 7449423635 or PlaceID == 100117331123089

-- Otimização
if getgenv().Setting.WhiteScreen then
    RunService:Set3dRenderingEnabled(false)
end

-- UI Visual
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SlimeXFixed_Indra"
ScreenGui.Parent = game.CoreGui
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 250, 0, 60)
MainFrame.Position = UDim2.new(0.5, -125, 0.1, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 1, 0)
Title.BackgroundTransparency = 1
Title.Text = "Carregando..."
Title.TextSize = 18
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Parent = MainFrame

function UpdateStatus(text)
    Title.Text = text
end

-- [[ SISTEMA DE BUSCA DE BAÚS (CORRIGIDO) ]] --
function GetClosestChest()
    local Character = plr.Character
    if not Character or not Character:FindFirstChild("HumanoidRootPart") then return nil end
    local RootPart = Character.HumanoidRootPart
    
    local Chests = {}
    
    for _, v in pairs(workspace:GetDescendants()) do
        if v:IsA("Part") and (string.find(v.Name, "Chest") or string.find(v.Name, "Box")) then
            if v:FindFirstChild("TouchInterest") then
                table.insert(Chests, v)
            end
        end
    end
    
    if #Chests == 0 then return nil end

    table.sort(Chests, function(a, b)
        return (a.Position - RootPart.Position).Magnitude < (b.Position - RootPart.Position).Magnitude
    end)
    
    return Chests[1]
end

-- [[ LÓGICA DO FAST ATTACK ]] --
local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegisterHit = Net:WaitForChild("RE/RegisterHit")
local RegisterAttack = Net:WaitForChild("RE/RegisterAttack")

local HIT_FUNCTION
task.defer(function()
    local PlayerScripts = plr:WaitForChild("PlayerScripts")
    local LocalScript = PlayerScripts:FindFirstChildOfClass("LocalScript")
    while not LocalScript do
        PlayerScripts.ChildAdded:Wait()
        LocalScript = PlayerScripts:FindFirstChildOfClass("LocalScript")
    end
    if getsenv then
        local ok, ScriptEnv = pcall(getsenv, LocalScript)
        if ok and ScriptEnv then
            HIT_FUNCTION = ScriptEnv._G.SendHitsToServer
        end
    end
end)

local FastAttackEnabled = true
local CPS = 15
local Range = 60

local function RunFastAttack()
    pcall(function()
        if not FastAttackEnabled then return end
        local char = plr.Character
        if not char or not char:FindFirstChild("HumanoidRootPart") then return end

        local hrp = char.HumanoidRootPart
        local enemiesFolder = Workspace:FindFirstChild("Enemies")
        if not enemiesFolder then return end
        
        for _, enemy in ipairs(enemiesFolder:GetChildren()) do
            local hum = enemy:FindFirstChild("Humanoid")
            local root = enemy:FindFirstChild("HumanoidRootPart")
            if hum and hum.Health > 0 and root and (root.Position - hrp.Position).Magnitude <= Range then
                local targets = {{enemy, root}}
                pcall(function()
                    if HIT_FUNCTION then HIT_FUNCTION(root, targets) else RegisterHit:FireServer(root, targets) end
                    RegisterAttack:FireServer(0)
                end)
                break
            end
        end
    end)
end

task.spawn(function()
    while task.wait(1/CPS) do RunFastAttack() end
end)

-- [[ UTILITÁRIOS ]] --
function EquipTool(name)
    local backpack = plr.Backpack
    local char = plr.Character
    local tool = backpack:FindFirstChild(name) or char:FindFirstChild(name)
    if tool and char and char:FindFirstChild("Humanoid") then
        char.Humanoid:EquipTool(tool)
    end
end

function TP(cframe)
    local char = plr.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = cframe
    end
end

-- [[ LÓGICA DE CORES DE HAKI E BOTÕES (RIP INDRA) - RESTAURADA ]] --
local HakiColors = {
    ["Really red"] = "Pure Red",
    ["Oyster"] = "Snow White",
    ["Hot pink"] = "Winter Sky"
}

function EquipHakiColor(colorName)
    local args = { [1] = { StorageName = colorName, Type = "AuraSkin", Context = "Equip" } }
    ReplicatedStorage.Modules.Net["RF/FruitCustomizerRF"]:InvokeServer(unpack(args))
end

function ActivateIndraButtons()
    if not World3 then return true end -- Se não for Sea 3, ignora
    
    local Summoner = workspace.Map:FindFirstChild("Boat Castle") and workspace.Map["Boat Castle"]:FindFirstChild("Summoner")
    if not Summoner then return false end
    
    local Circle = Summoner:FindFirstChild("Circle")
    if not Circle then return false end

    local allActive = true

    for _, pad in pairs(Circle:GetChildren()) do
        if pad.Name == "Part" and pad:FindFirstChild("Part") then
            local plate = pad.Part
            -- Se a cor NÃO for Verde Limão, significa que precisa ativar
            if tostring(plate.BrickColor) ~= "Lime green" then
                allActive = false
                local requiredColor = HakiColors[tostring(plate.BrickColor)]
                
                if requiredColor then
                    UpdateStatus("Ativando Botão: " .. requiredColor)
                    
                    -- 1. Equipa a cor
                    EquipHakiColor(requiredColor)
                    task.wait(0.3)
                    
                    -- 2. Ativa o Haki (Buso) se estiver desligado
                    if not plr.Character:FindFirstChild("HasBuso") then
                        CommF:InvokeServer("Buso")
                    end
                    task.wait(0.3)
                    
                    -- 3. Teleporta para o botão
                    TP(pad.CFrame + Vector3.new(0, 3, 0))
                    task.wait(1.5) -- Espera um pouco para registrar o toque
                else
                    UpdateStatus("Cor desconhecida no botão!")
                end
            end
        end
    end
    return allActive
end

-- [[ SERVER HOP ]] --
function HopServer()
    UpdateStatus("Procurando servidor...")
    local AllIDs = {}
    local function ListServers(cursor)
        local Raw = game:HttpGet("https://games.roblox.com/v1/games/" .. PlaceID .. "/servers/Public?sortOrder=Asc&limit=100" .. (cursor and "&cursor=" .. cursor or ""))
        return HttpService:JSONDecode(Raw)
    end

    local ServerSource = ListServers()
    for _, v in pairs(ServerSource.data) do
        if v.playing < v.maxPlayers and v.id ~= game.JobId then
            table.insert(AllIDs, v.id)
        end
    end
    
    if #AllIDs > 0 then
        TeleportService:TeleportToPlaceInstance(PlaceID, AllIDs[math.random(1, #AllIDs)], plr)
    else
        UpdateStatus("Server Hop falhou, retentando...")
        TeleportService:Teleport(PlaceID, plr)
    end
end

-- [[ LÓGICA PRINCIPAL (LOOP) ]] --
local ProcessingBoss = false
local ChestRetries = 0

spawn(function()
    while task.wait() do
        pcall(function()
            local Char = plr.Character
            if not Char or not Char:FindFirstChild("HumanoidRootPart") then return end
            
            -- Verifica Inventário
            local Chalice = plr.Backpack:FindFirstChild("God's Chalice") or Char:FindFirstChild("God's Chalice")
            local Fist = plr.Backpack:FindFirstChild("Fist of Darkness") or Char:FindFirstChild("Fist of Darkness")
            
            if ProcessingBoss then return end -- Pausa loop principal se estiver lidando com Boss

            -- >> 1. LÓGICA SEA 3 (Rip Indra + Haki) <<
            if World3 and Chalice and getgenv().Setting.ModFarm.SummonKillRipIndra then
                ProcessingBoss = true
                UpdateStatus("Cálice detectado! Verificando Haki...")
                
                -- Loop até ativar todos os botões
                local buttonsReady = false
                repeat 
                    buttonsReady = ActivateIndraButtons()
                    task.wait(1)
                until buttonsReady
                
                UpdateStatus("Botões Verdes! Invocando Indra...")
                EquipTool("God's Chalice")
                TP(CFrame.new(-5346.9, 423.9, -2725.1)) -- Local do pedestal
                task.wait(2) -- Tempo para o jogador clicar ou o auto-click (se tiver) funcionar
                -- Nota: O script posiciona você no pedestal. Você precisa clicar ou ter um auto-click.
                
            -- >> 2. LÓGICA SEA 2 (Barba Negra) <<
            elseif World2 and Fist and getgenv().Setting.ModFarm.SummonKillDarkbeard then
                ProcessingBoss = true
                UpdateStatus("Fist detectado! Indo para Arena...")
                EquipTool("Fist of Darkness")
                TP(CFrame.new(3777.58, 14.87, -3498.81))
                
            -- >> 3. AUTO CHEST COM BUFFER <<
            else
                local TargetChest = GetClosestChest()
                
                if TargetChest then
                    ChestRetries = 0 
                    UpdateStatus("Coletando: " .. TargetChest.Name)
                    Char:PivotTo(TargetChest:GetPivot())
                    firetouchinterest(Char.HumanoidRootPart, TargetChest, 0)
                    firetouchinterest(Char.HumanoidRootPart, TargetChest, 1)
                else
                    -- Contagem regressiva antes de trocar de server
                    ChestRetries = ChestRetries + 1
                    UpdateStatus("Procurando baús... (" .. ChestRetries .. "/25)")
                    
                    if ChestRetries >= 25 then -- Aprox 5 segundos tentando achar baú
                        UpdateStatus("Sem baús. Trocando servidor...")
                        task.wait(1)
                        HopServer()
                    end
                    task.wait(0.2) 
                end
            end
        end)
    end
end)

-- [[ LOOP DE BOSS (Auto Kill + Posicionamento) ]] --
spawn(function()
    while task.wait(0.5) do
        pcall(function()
            local Indra = workspace.Enemies:FindFirstChild("rip_indra")
            local Darkbeard = workspace.Enemies:FindFirstChild("Darkbeard")
            
            if Indra or Darkbeard then
                ProcessingBoss = true
                local Target = Indra or Darkbeard
                
                if Target and Target:FindFirstChild("HumanoidRootPart") and Target.Humanoid.Health > 0 then
                    UpdateStatus("Boss Ativo: " .. Target.Name)
                    EquipTool("Melee") 
                    -- TP seguro acima da cabeça do boss
                    TP(Target.HumanoidRootPart.CFrame * CFrame.new(0, 15, 0))
                    
                    -- Garante Haki ativo
                    if not plr.Character:FindFirstChild("HasBuso") then
                        CommF:InvokeServer("Buso")
                    end
                else
                    ProcessingBoss = false
                end
            end
        end)
    end
end)

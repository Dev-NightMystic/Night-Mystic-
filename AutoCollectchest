-- Serviços
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("StarterGui")

local plr = Players.LocalPlayer
local Remotes = ReplicatedStorage:WaitForChild("Remotes")
local CommF = Remotes:WaitForChild("CommF_")

-- Detecção de Mundo
local PlaceID = game.PlaceId
local World2 = PlaceID == 4442272183 or PlaceID == 79091703265657
local World3 = PlaceID == 7449423635 or PlaceID == 100117331123089

-- Otimização
if getgenv().Setting.WhiteScreen then
    RunService:Set3dRenderingEnabled(false)
end

-- Notificação
function Notify(txt)
    CoreGui:SetCore("SendNotification", {
        Title = "SlimeX + Fast Attack",
        Text = txt,
        Duration = 5
    })
end

-- UI Simples (Visual)
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SlimeXIndra"
ScreenGui.Parent = game.CoreGui
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 200, 0, 50)
MainFrame.Position = UDim2.new(0.5, -100, 0.1, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
MainFrame.Parent = ScreenGui
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 1, 0)
Title.BackgroundTransparency = 1
Title.Text = "Status: Iniciando..."
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Parent = MainFrame

function UpdateStatus(text)
    Title.Text = text
end

-- [[ LÓGICA DO FAST ATTACK (INTEGRADO) ]] --
-- Código extraído do seu arquivo enviado
local Net = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net")
local RegisterHit = Net:WaitForChild("RE/RegisterHit")
local RegisterAttack = Net:WaitForChild("RE/RegisterAttack")

local HIT_FUNCTION
task.defer(function()
    local PlayerScripts = plr:WaitForChild("PlayerScripts")
    local LocalScript = PlayerScripts:FindFirstChildOfClass("LocalScript")
    while not LocalScript do
        PlayerScripts.ChildAdded:Wait()
        LocalScript = PlayerScripts:FindFirstChildOfClass("LocalScript")
    end
    if getsenv then
        local ok, ScriptEnv = pcall(getsenv, LocalScript)
        if ok and ScriptEnv then
            HIT_FUNCTION = ScriptEnv._G.SendHitsToServer
        end
    end
end)

local FastAttackEnabled = true
local CPS = 15 -- Aumentei levemente para garantir hit no Boss
local Range = 60

local function RunFastAttack()
    pcall(function()
        if not FastAttackEnabled then return end
        local char = plr.Character
        if not char or not char:FindFirstChild("HumanoidRootPart") then return end

        local hrp = char.HumanoidRootPart
        local enemiesFolder = Workspace:FindFirstChild("Enemies")
        if not enemiesFolder then return end
        local enemies = enemiesFolder:GetChildren()

        -- Verifica inimigos próximos
        for _, enemy in ipairs(enemies) do
            local hum = enemy:FindFirstChild("Humanoid")
            local root = enemy:FindFirstChild("HumanoidRootPart")
            
            -- Se tiver vida e estiver no range
            if hum and hum.Health > 0 and root and (root.Position - hrp.Position).Magnitude <= Range then
                
                local targets = {}
                -- Coleta todos os alvos válidos
                for _, e in ipairs(enemies) do
                    local ehum = e:FindFirstChild("Humanoid")
                    local eroot = e:FindFirstChild("HumanoidRootPart")
                    if ehum and ehum.Health > 0 and eroot and (eroot.Position - hrp.Position).Magnitude <= Range then
                        table.insert(targets, {e, eroot})
                    end
                end

                -- Envia o hit via Remote ou Função interna
                pcall(function()
                    if HIT_FUNCTION then
                        HIT_FUNCTION(root, targets)
                    else
                        RegisterHit:FireServer(root, targets)
                    end
                    RegisterAttack:FireServer(0)
                end)
                break -- Ataca o grupo e sai do loop principal para não floodar excessivamente no mesmo frame
            end
        end
    end)
end

-- Loop do Fast Attack
task.spawn(function()
    while task.wait(1 / CPS) do
        RunFastAttack()
    end
end)

-- [[ FUNÇÕES DE MOVIMENTO E EQUIPAR ]] --
function EquipTool(name)
    local backpack = plr.Backpack
    local char = plr.Character
    local tool = backpack:FindFirstChild(name) or char:FindFirstChild(name)
    if tool and char and char:FindFirstChild("Humanoid") then
        char.Humanoid:EquipTool(tool)
    end
end

function TP(cframe)
    local char = plr.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = cframe
    end
end

-- [[ LÓGICA DE RIP INDRA (HAKI + BOTÕES) ]] --
local HakiColors = {
    ["Really red"] = "Pure Red",
    ["Oyster"] = "Snow White",
    ["Hot pink"] = "Winter Sky"
}

function EquipHakiColor(colorName)
    local args = { [1] = { StorageName = colorName, Type = "AuraSkin", Context = "Equip" } }
    ReplicatedStorage.Modules.Net["RF/FruitCustomizerRF"]:InvokeServer(unpack(args))
end

function ActivateIndraButtons()
    if not World3 then return end
    
    local Summoner = workspace.Map:FindFirstChild("Boat Castle") and workspace.Map["Boat Castle"]:FindFirstChild("Summoner")
    if not Summoner then return end
    
    local Circle = Summoner:FindFirstChild("Circle")
    if not Circle then return end

    local allActive = true

    for _, pad in pairs(Circle:GetChildren()) do
        if pad.Name == "Part" and pad:FindFirstChild("Part") then
            local plate = pad.Part
            if tostring(plate.BrickColor) ~= "Lime green" then
                allActive = false
                local requiredColor = HakiColors[tostring(plate.BrickColor)]
                
                if requiredColor then
                    UpdateStatus("Ativando Botão: " .. requiredColor)
                    EquipHakiColor(requiredColor)
                    task.wait(0.5)
                    if not plr.Character:FindFirstChild("HasBuso") then
                        CommF:InvokeServer("Buso")
                    end
                    task.wait(0.5)
                    TP(pad.CFrame + Vector3.new(0, 3, 0))
                    task.wait(1)
                end
            end
        end
    end
    return allActive
end

-- [[ LOOP PRINCIPAL (AUTO CHEST + PROCESSAMENTO) ]] --
local AutoFarm = true
local ProcessingBoss = false

spawn(function()
    while task.wait() do
        pcall(function()
            if AutoFarm and not ProcessingBoss then
                local Char = plr.Character
                local HRP = Char and Char:FindFirstChild("HumanoidRootPart")
                
                -- Verifica Itens
                local Chalice = plr.Backpack:FindFirstChild("God's Chalice") or Char:FindFirstChild("God's Chalice")
                local Fist = plr.Backpack:FindFirstChild("Fist of Darkness") or Char:FindFirstChild("Fist of Darkness")
                
                -- >> 1. LÓGICA RIP INDRA (SEA 3) <<
                if World3 and Chalice and getgenv().Setting.ModFarm.SummonKillRipIndra then
                    ProcessingBoss = true
                    UpdateStatus("Cálice! Iniciando Indra...")
                    
                    repeat
                        task.wait(1)
                        local buttonsReady = ActivateIndraButtons()
                    until buttonsReady or not plr.Character or plr.Character.Humanoid.Health <= 0
                    
                    UpdateStatus("Botões OK! Invocando...")
                    EquipTool("God's Chalice")
                    task.wait(0.5)
                    TP(CFrame.new(-5346.9, 423.9, -2725.1)) 
                    task.wait(2)
                    
                -- >> 2. LÓGICA BARBA NEGRA (SEA 2) <<
                elseif World2 and Fist and getgenv().Setting.ModFarm.SummonKillDarkbeard then
                    ProcessingBoss = true
                    UpdateStatus("Fist! Indo para Arena...")
                    EquipTool("Fist of Darkness")
                    TP(CFrame.new(3777.58, 14.87, -3498.81))
                    task.wait(2)
                    
                -- >> 3. AUTO CHEST <<
                else
                    UpdateStatus("Farmando Baús...")
                    local Chest = game.Workspace:FindFirstChild("Chest4") or game.Workspace:FindFirstChild("Chest3") or game.Workspace:FindFirstChild("Chest2")
                    
                    if Chest then
                        if HRP then
                            Char:PivotTo(Chest:GetPivot())
                            firetouchinterest(HRP, Chest, 0)
                            firetouchinterest(HRP, Chest, 1)
                        end
                    else
                        UpdateStatus("Sem baús. Hop Server...")
                        HopServer()
                    end
                end
            end
        end)
    end
end)

-- [[ LOOP DE POSICIONAMENTO PARA ATAQUE ]] --
-- O Fast Attack roda sozinho, aqui só precisamos mover o boneco para perto do boss
spawn(function()
    while task.wait() do
        pcall(function()
            local Indra = workspace.Enemies:FindFirstChild("rip_indra")
            local Darkbeard = workspace.Enemies:FindFirstChild("Darkbeard")
            
            if Indra or Darkbeard then
                ProcessingBoss = true -- Pausa o farm de baús
                local Target = Indra or Darkbeard
                
                if Target and Target:FindFirstChild("HumanoidRootPart") and Target.Humanoid.Health > 0 then
                    UpdateStatus("Matando: " .. Target.Name)
                    EquipTool("Melee") -- Equipa luta/espada para o Fast Attack funcionar
                    
                    -- Teleporta para cima da cabeça do Boss (Posição segura)
                    TP(Target.HumanoidRootPart.CFrame * CFrame.new(0, 15, 0))
                    
                    -- Mantém Haki ativo para dar dano
                    if not plr.Character:FindFirstChild("HasBuso") then
                        CommF:InvokeServer("Buso")
                    end
                else
                    -- Boss morreu ou despawnou
                    ProcessingBoss = false
                end
            elseif ProcessingBoss then
                ProcessingBoss = false
            end
        end)
    end
end)

-- [[ FUNÇÃO DE SERVER HOP ]] --
function HopServer()
    local PlaceID = game.PlaceId
    local AllIDs = {}
    local function ListServers(cursor)
        local Raw = game:HttpGet("https://games.roblox.com/v1/games/" .. PlaceID .. "/servers/Public?sortOrder=Asc&limit=100" .. (cursor and "&cursor=" .. cursor or ""))
        return game:GetService("HttpService"):JSONDecode(Raw)
    end

    local ServerSource = ListServers()
    for _, v in pairs(ServerSource.data) do
        if v.playing < v.maxPlayers then
            table.insert(AllIDs, v.id)
        end
    end
    
    if #AllIDs > 0 then
        game:GetService("TeleportService"):TeleportToPlaceInstance(PlaceID, AllIDs[math.random(1, #AllIDs)], plr)
    else
        game:GetService("TeleportService"):Teleport(PlaceID, plr)
    end
end
